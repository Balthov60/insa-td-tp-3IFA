#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <assert.h>

#include "mem.h"

void printTest(char * text)
{
    printf("\r\n");
    printf("////////////////\r\n");
    printf("%s\r\n", text);
    printf("////////////////\r\n");
    printf("\r\n");
}

void test6fois42(){
    printTest("Test 6 * 42 Début");
    char * p[6];
    
    for(int i = 0; i<6; i++){
        p[i] = mem_alloc( 42 );
        
        if (p[i] != NULL) // check whether the allocation was successful
            printf("allocated 42 bytes at %p\n", p[i]);
        else
            printf("allocation n°%d failed\r\n", i + 1);
    }
    mem_show_heap();
    
    printf("\r\n");
    printf("deallocation\n");
    for(int i = 0; i<6; i++){
        mem_release( p[i] );
    }
    mem_show_heap();
    
    printTest("Test 6 * 42 Fin");
}

void test7fois42(){
    printTest("Test 7 * 42 Début");
    char * p[7];
    
    for(int i = 0; i<7; i++){
        p[i] = mem_alloc( 42 );
        if (p[i] != NULL) // check whether the allocation was successful
            printf("allocated 42 bytes at %p\n", p[i]);
        else
            printf("allocation n°%d failed\r\n", i + 1);
    }
    mem_show_heap();
    
    printf("\r\n");
    printf("deallocation\n");
    for(int i = 0; i<7; i++){
        mem_release( p[i] );
    }
    mem_show_heap();
    
    printTest("Test 7 * 42 Fin");
}

void test2fois200(){
    printTest("Test 2 * 200 Début");
    char * p[2];

    for(int i = 0; i<2; i++){
        p[i] = mem_alloc( 200 );
        if (p[i] != NULL) // check whether the allocation was successful
            printf("allocated 200 bytes at %p\n", p[i]);
        else
            printf("allocation n°%d failed\r\n", i + 1);
    }
    mem_show_heap();
    
    printf("\r\n");
    printf("deallocation\n");
    for(int i = 0; i<2; i++){
        mem_release( p[i] );
    }
    mem_show_heap();
    
    printTest("Test 2 * 200 Fin");
}

void test6fois42puis1fois42() {
    printTest("Test 6 * 42 puis 1 * 42 Début");
    char * p[6];
    
    for(int i = 0; i<6; i++){
        p[i] = mem_alloc( 42 );
        
        if (p[i] != NULL) // check whether the allocation was successful
            printf("allocated 42 bytes at %p\n", p[i]);
        else
            printf("allocation n°%d failed\r\n", i + 1);
    }
    mem_show_heap();
    
    printf("\r\n");
    printf("deallocation %p\n", p[5]);
    mem_release( p[5] );
    mem_show_heap();
    
    p[5] = mem_alloc( 42 );
    printf("\r\n");
    if (p[5] != NULL) // check whether the allocation was successful
        printf("allocated 42 bytes at %p\n", p[5]);
    else
        printf("allocation n°7 failed\r\n");
    
    mem_show_heap();
    
    printf("\r\n");
    printf("deallocation\n");
    for(int i = 0; i<7; i++) {
        mem_release( p[i] );
    }
    mem_show_heap();
    
    printTest("Test 6 * 42 puis 1 * 42 Fin");
}

void test200puis300(){
    printTest("Test 200 puis 300 Début");

    char * p = mem_alloc( 200 );
    printf("\r\n");
    if (p != NULL) // check whether the allocation was successful
        printf("allocated 200 bytes at %p\n", p);
    else
        printf("allocation 1 failed\r\n");
    
    mem_show_heap();
    
    
    printf("\r\n");
    printf("deallocation %p\n", p);
    mem_release( p );
    mem_show_heap();

    
    printf("\r\n");
    printf("allocation 300\n");

    p = mem_alloc( 300 );
    printf("\r\n");
    if (p != NULL) // check whether the allocation was successful
        printf("allocated 300 bytes at %p\n", p);
    else
        printf("allocation 2 failed\r\n");
    mem_show_heap();

    
    printf("\r\n");
    printf("deallocation %p\n", p);
    mem_release( p );
    mem_show_heap();
    
    printTest("Test 200 puis 300 Fin");
}

int main()
{
    // initialize the allocator
    mem_init();
    mem_show_heap();
    
    //char *p = mem_alloc( 42 );
    //assert( p != NULL ); // check whether the allocation was successful
    //printf("allocated 42 bytes at %p\n", p);
    
    test6fois42();
    test7fois42();
    test2fois200();
    
    test6fois42puis1fois42();
    test200puis300();
    
    mem_show_heap();
}
